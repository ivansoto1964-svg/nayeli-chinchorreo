// Servicio de clientes (API keys por cliente) – ETAPA 7.2
const fs = require("fs");
const path = require("path");

// Ruta del archivo de clientes
const CLIENTS_FILE = path.resolve(process.cwd(), "data", "clients.json");

// Cache en memoria
let clientsCache = null;
let lastLoadedAt = 0;
const CACHE_TTL_MS = 10_000; // 10 segundos

function loadClientsFromDisk() {
  if (!fs.existsSync(CLIENTS_FILE)) {
    throw new Error(`clients.json no existe en ${CLIENTS_FILE}`);
  }

  const raw = fs.readFileSync(CLIENTS_FILE, "utf8");
  const data = JSON.parse(raw);

  if (!data || typeof data !== "object" || !data.keys) {
    throw new Error("clients.json inválido: falta 'keys'");
  }

  clientsCache = data.keys;
  lastLoadedAt = Date.now();
}

function getClients() {
  const now = Date.now();
  if (!clientsCache || now - lastLoadedAt > CACHE_TTL_MS) {
    loadClientsFromDisk();
  }
  return clientsCache;
}

function getClientByApiKey(apiKey) {
  if (!apiKey) return null;
  const clients = getClients();
  const client = clients[apiKey];
  return client || null;
}

module.exports = {
  getClientByApiKey,
};

